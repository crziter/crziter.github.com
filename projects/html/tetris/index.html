<!DOCTYPE html>
<html>
<head>
	<title>Tetris game by Mr. Binh</title>
	<meta charset="utf-8">
	<style type="text/css">
		#container {
			margin: 0px auto;
			width: 310px;
		}

		#tr-board {
			background-color: yellow;
			border: 1px solid black;
			float: left;
		}

		#tr-control {
			background-color: green;
			width: 100px;
			height: 527px;
			margin-left: 300px;
			border: 1px solid black;
		}
	</style>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script type="text/javascript">
function Current(e,t,n){this.x=e;this.y=t;this.element=n}function Game(){this.width=10;this.height=17;this.tmrId=0;this.diem=0;this.board=new Array;for(var e=0;e<this.height;++e){this.board[e]=new Array;for(var t=0;t<this.width;++t){this.board[e][t]=0}}this.elements=[[[1,1,1,1]],[[1],[1],[1],[1]],[[0,1],[0,1],[1,1]],[[1,0],[1,0],[1,1]],[[1,1,1],[0,1,0]],[[1,0],[1,1],[0,1]],[[0,1],[1,1],[1,0]]];this.current=new Current(0,0,this.elements[0])}var canvas,ctx;var cwidth,cheight;var cellsize=30;var game;Game.prototype.rotateCurrent=function(e){var t=this.current.element;var n=new Array;for(var r=0;r<t[0].length;++r){n[r]=new Array;for(var i=0;i<t.length;++i)n[r][i]=0}var s=0,o=0,u,a;if(e=="left"){u=0;a=n.length-1;while(true){n[a][u]=t[o][s];s++;if(s>=t[0].length){o++;s=0;if(o>=t.length)break}a--;if(a<0){u++;a=n.length-1}}}else if(e=="right"){u=n[0].length-1;a=0;while(true){n[a][u]=t[o][s];s++;if(s>=t[0].length){o++;s=0;if(o>=t.length)break}a++;if(a>=n.length){u--;a=0}}}this.current.element=n};Game.prototype.createCurrent=function(){var e=Math.round(Math.random()*6);this.current=new Current(this.width-this.elements[e][0].length>>1,0,this.elements[e])};Game.prototype.drawGrid=function(){var e;ctx.beginPath();for(var t=1;t<this.width;++t){e=t*cellsize+t;ctx.moveTo(e,0);ctx.lineTo(e,cheight)}for(var t=1;t<this.height;++t){e=t*cellsize+t;ctx.moveTo(0,e);ctx.lineTo(cheight,e)}ctx.stroke();for(var n=0;n<this.board.length;++n)for(var r=0;r<this.board[n].length;++r){if(this.board[n][r]!=0)this.drawBox(r,n,this.board[n][r])}};Game.prototype.drawBox=function(e,t,n){ctx.fillRect(e*cellsize+e,t*cellsize+t,cellsize,cellsize)};Game.prototype.drawCurrent=function(){for(var e=0;e<this.current.element.length;++e){for(var t=0;t<this.current.element[e].length;++t){if(this.current.element[e][t]!=0)this.drawBox(this.current.x+t,this.current.y+e,this.current.element[e][t])}}};Game.prototype.draw=function(){ctx.clearRect(0,0,cwidth,cheight);this.drawGrid();this.drawCurrent()};Game.prototype.move=function(e){if(e=="left"){if(this.current.x>0)this.current.x--}else if(e=="right"){if(this.current.x+this.current.element[0].length<this.width)this.current.x++}};Game.prototype.saveCurrentToBoard=function(){for(var e=0;e<this.current.element.length;++e){for(var t=0;t<this.current.element[e].length;++t){if(this.current.element[e][t]>0)this.board[this.current.y+e][this.current.x+t]=this.current.element[e][t]}}};Game.prototype.stop=function(){clearInterval(this.tmrId);alert("You lost!")};Game.prototype.checkToDestroy=function(){var e;for(var t=this.board.length-1;t>=0;--t){e=true;for(var n=0;n<this.board[0].length;++n){if(this.board[t][n]==0){e=false;break}}if(e){this.diem+=5;jQuery("#diem").text(this.diem);for(var r=t;r>0;--r){for(var i=0;i<this.board[0].length;++i){this.board[r][i]=this.board[r-1][i]}}for(var i=0;i<this.board;++i)this.board[0][i]=0}}};Game.prototype.step=function(){if(this.current.y+this.current.element.length>=this.height){this.saveCurrentToBoard();this.checkToDestroy();this.createCurrent();this.draw();return}var e,t;for(var n=this.current.element.length-1;n>=0;--n){for(var r=0;r<this.current.element[0].length;++r){e=this.current.y+n+1;t=this.current.x+r;if(this.current.element[n][r]!=0&&this.board[e][t]!=0){this.saveCurrentToBoard();this.checkToDestroy();this.createCurrent();this.draw();return}}}this.current.y+=1;this.draw()};jQuery(document).ready(function(){canvas=jQuery("#tr-board")[0];ctx=canvas.getContext("2d");game=new Game;cwidth=canvas.width;cheight=canvas.height;game.createCurrent();game.draw();jQuery(document).bind("keyup",function(e){var t=e.keyCode||e.which;if(t==90){game.rotateCurrent("left");game.draw()}else if(t==88){game.rotateCurrent("right");game.draw()}else if(t==37){game.move("left");game.draw()}else if(t==39){game.move("right");game.draw()}else if(t==40){game.step()}else if(t==38){if(game.tmrId==0)game.tmrId=setInterval("game.step()",800);else{clearInterval(game.tmrId);game.tmrId=0}}});game.tmrId=setInterval("game.step()",800)})
	</script>
</head>
<body>
	<div id="container">
		<div id="game">
			<canvas id="tr-board" width=310 height=527></canvas>
			<div id="tr-control">
				Diem: 
				<span id="diem">0</span>
			</div>
		</div>
	</div>
</body>
</html>
